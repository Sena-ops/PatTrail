<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PatTrail Offline Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
    </style>
</head>
<body>
    <h1>PatTrail Offline Functionality Test</h1>
    
    <div class="test-section">
        <h2>Database Test</h2>
        <button onclick="testDatabase()" class="btn-primary">Test IndexedDB</button>
        <div id="db-status" class="status"></div>
    </div>
    
    <div class="test-section">
        <h2>Network Status</h2>
        <div id="network-status" class="status info">
            Online: <span id="online-status">Checking...</span>
        </div>
        <button onclick="testOffline()" class="btn-warning">Simulate Offline</button>
        <button onclick="testOnline()" class="btn-success">Simulate Online</button>
    </div>
    
    <div class="test-section">
        <h2>State Persistence Test</h2>
        <button onclick="saveTestState()" class="btn-primary">Save Test State</button>
        <button onclick="loadTestState()" class="btn-primary">Load Test State</button>
        <button onclick="clearTestState()" class="btn-warning">Clear Test State</button>
        <div id="state-status" class="status"></div>
    </div>
    
    <div class="test-section">
        <h2>Queue Test</h2>
        <button onclick="addTestBatch()" class="btn-primary">Add Test Batch</button>
        <button onclick="checkQueue()" class="btn-primary">Check Queue</button>
        <button onclick="clearQueue()" class="btn-warning">Clear Queue</button>
        <div id="queue-status" class="status"></div>
    </div>

    <script src="db.js"></script>
    <script src="net.js"></script>
    
    <script>
        let walkQueue, networking;
        
        // Initialize components
        async function init() {
            try {
                walkQueue = new WalkQueueDB();
                networking = new WalkNetworking();
                
                await walkQueue.init();
                updateNetworkStatus();
                
                document.getElementById('db-status').innerHTML = 
                    '<div class="success">IndexedDB initialized successfully</div>';
                    
            } catch (error) {
                document.getElementById('db-status').innerHTML = 
                    `<div class="error">IndexedDB initialization failed: ${error.message}</div>`;
            }
        }
        
        // Test database functionality
        async function testDatabase() {
            try {
                const status = document.getElementById('db-status');
                
                // Test metadata storage
                await walkQueue.setMetadata('test-key', 'test-value');
                const retrieved = await walkQueue.getMetadata('test-key');
                
                if (retrieved === 'test-value') {
                    status.innerHTML = '<div class="success">Database test passed - metadata storage working</div>';
                } else {
                    status.innerHTML = '<div class="error">Database test failed - metadata retrieval mismatch</div>';
                }
                
                // Clean up
                await walkQueue.removeMetadata('test-key');
                
            } catch (error) {
                document.getElementById('db-status').innerHTML = 
                    `<div class="error">Database test failed: ${error.message}</div>`;
            }
        }
        
        // Update network status
        function updateNetworkStatus() {
            const onlineStatus = document.getElementById('online-status');
            onlineStatus.textContent = navigator.onLine ? 'Yes' : 'No';
            onlineStatus.style.color = navigator.onLine ? 'green' : 'red';
        }
        
        // Simulate offline
        function testOffline() {
            // This is just for display - we can't actually make the browser offline
            document.getElementById('network-status').innerHTML = 
                '<div class="status warning">Offline simulation - check browser DevTools Network tab to disable network</div>';
        }
        
        // Simulate online
        function testOnline() {
            updateNetworkStatus();
        }
        
        // Save test state
        async function saveTestState() {
            try {
                await walkQueue.saveCurrentWalk(123, new Date().toISOString());
                document.getElementById('state-status').innerHTML = 
                    '<div class="success">Test state saved successfully</div>';
            } catch (error) {
                document.getElementById('state-status').innerHTML = 
                    `<div class="error">Failed to save state: ${error.message}</div>`;
            }
        }
        
        // Load test state
        async function loadTestState() {
            try {
                const state = await walkQueue.getCurrentWalk();
                if (state) {
                    document.getElementById('state-status').innerHTML = 
                        `<div class="success">State loaded: Walk ID ${state.walkId}, Started: ${state.startedAt.toLocaleString()}</div>`;
                } else {
                    document.getElementById('state-status').innerHTML = 
                        '<div class="info">No saved state found</div>';
                }
            } catch (error) {
                document.getElementById('state-status').innerHTML = 
                    `<div class="error">Failed to load state: ${error.message}</div>`;
            }
        }
        
        // Clear test state
        async function clearTestState() {
            try {
                await walkQueue.clearCurrentWalk();
                document.getElementById('state-status').innerHTML = 
                    '<div class="success">Test state cleared successfully</div>';
            } catch (error) {
                document.getElementById('state-status').innerHTML = 
                    `<div class="error">Failed to clear state: ${error.message}</div>`;
            }
        }
        
        // Add test batch
        async function addTestBatch() {
            try {
                const testPoints = [
                    { lat: 37.7749, lon: -122.4194, ts: new Date().toISOString() },
                    { lat: 37.7750, lon: -122.4195, ts: new Date().toISOString() }
                ];
                
                await walkQueue.addBatch({
                    walkId: 123,
                    points: testPoints
                });
                
                document.getElementById('queue-status').innerHTML = 
                    '<div class="success">Test batch added successfully</div>';
            } catch (error) {
                document.getElementById('queue-status').innerHTML = 
                    `<div class="error">Failed to add batch: ${error.message}</div>`;
            }
        }
        
        // Check queue
        async function checkQueue() {
            try {
                const size = await walkQueue.getQueueSize();
                const batches = await walkQueue.getBatchesByWalkId(123);
                
                document.getElementById('queue-status').innerHTML = 
                    `<div class="info">Queue size: ${size}, Batches for walk 123: ${batches.length}</div>`;
            } catch (error) {
                document.getElementById('queue-status').innerHTML = 
                    `<div class="error">Failed to check queue: ${error.message}</div>`;
            }
        }
        
        // Clear queue
        async function clearQueue() {
            try {
                await walkQueue.clearAll();
                document.getElementById('queue-status').innerHTML = 
                    '<div class="success">Queue cleared successfully</div>';
            } catch (error) {
                document.getElementById('queue-status').innerHTML = 
                    `<div class="error">Failed to clear queue: ${error.message}</div>`;
            }
        }
        
        // Event listeners
        window.addEventListener('online', updateNetworkStatus);
        window.addEventListener('offline', updateNetworkStatus);
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
